# needsrootforbuild

Url:            http://www.suse.com/cloud
Name:           __NAME__
Summary:        SUSE Cloud product .iso
Version:        __VERSION__
Release:        __RELEASE__
Group:          System/Management
License:        GPLv2
Source:         __SOURCE__
BuildRoot:      %{_tmppath}/%{name}-%{version}-build
BuildArch:      noarch
BuildRequires:  containment-rpm-config

%description
This package installs the SUSE Cloud product .iso into %containment_image_dest_dir.  It
is intended to be installed on the SUSE Cloud admin server.

%prep

%build
# empty: no compile job

%install

install -d -m 755 $RPM_BUILD_ROOT%containment_image_dest_dir
ln %{S:0} $RPM_BUILD_ROOT%containment_image_dest_dir

%clean
rm -rf $RPM_BUILD_ROOT

%post
# N.B. It appears that if this rpm is installed during a kiwi build,
# the below changes to fstab get overwritten.  So you should ensure
# that the following entries are added to fstab near the end of the
# image build, e.g. via the build-custom script which a typical
# Studio-generated config.sh produces.

me="%{name}-%{version}-%{release}.%{_build_arch}.rpm"
iso=$( echo %containment_image_dest_dir/%{name}-%{version}-%{release}.iso )

cat <<EOF >/etc/fstab

# Auto-generated by $me at `date`
$iso   /srv/tftpboot/repos/Cloud   iso9660 noauto 0 0
# End auto-generated section from $me"
EOF

%postun
me="%{name}-%{version}-%{release}.%{_build_arch}.rpm"
iso=$( echo %containment_image_dest_dir/%{name}-%{version}-%{release}.iso )

perl -0777pi -e \
    "s/\n+# Auto-generated by $me.*\n(.*\n)*^# End auto-generated section from $me//m" \
    /etc/fstab

%files
%defattr(-, root, root)
%containment_image_dest_dir
